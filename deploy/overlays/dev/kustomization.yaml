apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

configurations:
  - kustomizeconfig.yaml

resources:
 - ../../base
 - ../../webhook # comment to disable webhook

images:
- name: docker.io/ofekmeister/csi-gcs
  newTag: dev
- name: csi-gcs-webhook-server
  newTag: dev

namespace: kube-system

replicas:
  - name: csi-gcs-webhook-server
    count: 1

patchesStrategicMerge:
- uselocalimage.yaml
- webhook-uselocalimage.yaml # comment to disable webhook
- webhook-cert-server.yaml # comment to disable webhook
- webhook-cert-client.yaml # comment to disable webhook
- webhook-verbose.yaml # comment to disable webhook

# run 'invoke tls-cert' to generate the tls.crt and tls.key
secretGenerator:
  - name: csi-gcs-webhook
    files:
      - tls.crt=secrets/tls.crt
      - tls.key=secrets/tls.key
      - ca=secrets/tls.crt # shouldn't be needed see WEBHOOK_CA_BUNDLE fieldref
    type: "kubernetes.io/tls"

vars:
  - name: WEBHOOK_CA_BUNDLE
    objref:
      apiVersion: v1
      kind: Secret
      name: csi-gcs-webhook
    fieldref:
      fieldpath: data.ca # should be possible to do data[tls.crt] but doesn't seem to work with kustomize/v4.1.2